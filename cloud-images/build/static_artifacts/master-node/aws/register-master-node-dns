#!/usr/bin/env bash

set -o pipefail
set -e

INSTANCE_PRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
AVAILABILITY_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
REGION=$(echo ${AVAILABILITY_ZONE} | sed 's/.$//')

USER_DATA=$(curl -s http://169.254.169.254/latest/user-data)

SYSTEM_ID=$(echo ${USER_DATA} | jq '.lattice.system_id' | tr -d '"')
NAME=$(echo ${USER_DATA} | jq '.lattice.name' | tr -d '"')
ROUTE53_PRIVATE_ZONE_ID=$(echo ${USER_DATA} | jq '.lattice.route53_private_zone_id' | tr -d '"')

STATE_S3_BUCKET=$(echo ${USER_DATA} | jq '.lattice.state_s3_bucket' | tr -d '"')
STATE_S3_KEY_PREFIX=$(echo ${USER_DATA} | jq '.lattice.state_s3_key_prefix' | tr -d '"')

mkdir -p /tmp/terraform-state/master-node-dns
cp /opt/terraform/modules/master-node-dns/* \
   /tmp/terraform-state/master-node-dns

cd /tmp/terraform-state/master-node-dns

sleep 30

/opt/terraform/bin/terraform init -force-copy \
    -backend-config="bucket=${STATE_S3_BUCKET}" \
    -backend-config="key=${STATE_S3_KEY_PREFIX}/master-node-dns/terraform.tfstate" \
    -backend-config="region=${REGION}"

/opt/terraform/bin/terraform apply -auto-approve \
    -var "system_id=${SYSTEM_ID}" \
    -var "region=${REGION}" \
    -var "name=${NAME}" \
    -var "route53_private_zone_id=${ROUTE53_PRIVATE_ZONE_ID}" \
    -var "instance_private_ip=${INSTANCE_PRIVATE_IP}"
