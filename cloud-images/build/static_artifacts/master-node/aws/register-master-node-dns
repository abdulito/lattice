#!/usr/bin/env bash

set -o pipefail
set -e

INSTANCE_PRIVATE_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)
AVAILABILITY_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
REGION=$(echo ${AVAILABILITY_ZONE} | sed 's/.$//')

USER_DATA=$(curl -s http://169.254.169.254/latest/user-data)

NAME=$(echo ${USER_DATA} | jq '.lattice.name' | tr -d '"')
ROUTE53_PRIVATE_ZONE_ID=$(echo ${USER_DATA} | jq '.lattice.route53_private_zone_id' | tr -d '"')

STATE_S3_BUCKET=$(echo ${USER_DATA} | jq '.lattice.state_s3_bucket' | tr -d '"')
STATE_S3_KEY_PREFIX=$(echo ${USER_DATA} | jq '.lattice.state_s3_key_prefix' | tr -d '"')

n=0
until [ $n -ge 5 ]
do
  /usr/bin/docker run \
    --network host \
    gcr.io/lattice-dev/kevinrosendahl-debug-kubernetes-aws-master-node-register-dns \
    --work-directory /tmp/terraform-state/master-node-dns \
    --s3-bucket ${STATE_S3_BUCKET} \
    --s3-key-prefix ${STATE_S3_KEY_PREFIX} \
    --module-source-path /opt/terraform/modules/master-node-dns/* \
    --region ${REGION} \
    --name ${NAME} \
    --route53-zone-id ${ROUTE53_PRIVATE_ZONE_ID} \
    --instance-private-ip ${INSTANCE_PRIVATE_IP} \
     && exit 0  # exit on success
  n=$[$n+1]
  sleep 15
done

exit 1
