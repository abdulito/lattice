#!/usr/bin/env bash

set -o pipefail
set -e

INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
AVAILABILITY_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
REGION=$(echo ${AVAILABILITY_ZONE} | sed 's/.$//')

USER_DATA=$(curl -s http://169.254.169.254/latest/user-data)

LATTICE_ID=$(echo ${USER_DATA} | jq '.lattice.lattice_id' | tr -d '"')
MASTER_NAME=$(echo ${USER_DATA} | jq '.lattice.master_name' | tr -d '"')

STATE_S3_BUCKET=$(echo ${USER_DATA} | jq '.lattice.state_s3_bucket' | tr -d '"')
STATE_S3_KEY_PREFIX=$(echo ${USER_DATA} | jq '.lattice.state_s3_key_prefix' | tr -d '"')

CONTROL_PLANE_CONTAINER_CHANNEL=$(echo ${USER_DATA} | jq '.lattice.control_plane_container_channel' | tr -d '"')
ATTACH_ETCD_VOLUME_IMAGE=${CONTROL_PLANE_CONTAINER_CHANNEL}kubernetes-aws-master-node-attach-etcd-volume:latest

n=0
until [ $n -ge 5 ]
do
    /usr/bin/docker pull ${ATTACH_ETCD_VOLUME_IMAGE} \
    && \
    /usr/bin/docker run \
        --network host \
        ${ATTACH_ETCD_VOLUME_IMAGE} \
        --work-directory /tmp/terraform-state/etcd-volume-attachment \
        --terraform-state-s3-bucket ${STATE_S3_BUCKET} \
        --terraform-state-s3-key-prefix ${STATE_S3_KEY_PREFIX} \
        --terraform-module-source-path /etc/terraform/modules \
        --region ${REGION} \
        --lattice-id ${LATTICE_ID} \
        --name ${MASTER_NAME} \
        --instance-id ${INSTANCE_ID} \
        --device-name ${1} \
     && exit 0  # exit on success
  n=$[$n+1]
  sleep 15
done

exit 1
