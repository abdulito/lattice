#!/usr/bin/env bash

set -o pipefail
set -e

AVAILABILITY_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
REGION=$(echo ${AVAILABILITY_ZONE} | sed 's/.$//')

USER_DATA=$(curl -s http://169.254.169.254/latest/user-data)
AWS_ACCOUNT_ID=$(echo ${USER_DATA} | jq '.lattice.aws_account_id' | tr -d '"')
VPC_ID=$(echo ${USER_DATA} | jq '.lattice.vpc_id' | tr -d '"')
ROUTE53_PRIVATE_ZONE_ID=$(echo ${USER_DATA} | jq '.lattice.route53_private_zone_id' | tr -d '"')
SUBNET_IDS=$(echo ${USER_DATA} | jq '.lattice.subnet_ids' | tr -d '"')
MASTER_NODE_SECURITY_GROUP_ID=$(echo ${USER_DATA} | jq '.lattice.master_node_security_group_id' | tr -d '"')
BASE_NODE_AMI_ID=$(echo ${USER_DATA} | jq '.lattice.base_node_ami_id' | tr -d '"')
KEY_NAME=$(echo ${USER_DATA} | jq '.lattice.key_name' | tr -d '"')
STATE_S3_BUCKET=$(echo ${USER_DATA} | jq '.lattice.state_s3_bucket' | tr -d '"')

INITIAL_SYSTEM_URL=$(echo ${USER_DATA} | jq '.lattice.system_definition_url' | tr -d '"')
CONTROL_PLANE_CONTAINER_CHANNEL=$(echo ${USER_DATA} | jq '.lattice.control_plane_container_channel' | tr -d '"')

n=0
until [ $n -ge 5 ]
do
  /usr/bin/docker run \
    --network host \
    -v /etc/opt/kubernetes/admin/kubeconfig:/etc/bootstrap-lattice/kubeconfig \
    ${CONTROL_PLANE_CONTAINER_CHANNEL}latticectl:latest \
    cluster kubernetes bootstrap \
    --initial-system-definition-url ${INITIAL_SYSTEM_URL} \
    --kubeconfig /etc/bootstrap-lattice/kubeconfig \
    --lattice-controller-manager-image ${CONTROL_PLANE_CONTAINER_CHANNEL}kubernetes-lattice-controller-manager \
    --lattice-controller-manager-terraform-module-path /etc/terraform/modules \
    --manager-api-image ${CONTROL_PLANE_CONTAINER_CHANNEL}kubernetes-manager-api-rest \
    --component-builder-image ${CONTROL_PLANE_CONTAINER_CHANNEL}kubernetes-component-builder \
    --component-build-docker-artifact-registry ${AWS_ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com \
    --component-build-docker-artifact-registry-auth-type aws-ec2-role \
    --component-build-docker-artifact-repository component-builds \
    --component-builder-docker-api-version '1.24' \
    --cloud-provider AWS \
    --cloud-provider-var account-id=${AWS_ACCOUNT_ID} \
    --cloud-provider-var region=${REGION} \
    --cloud-provider-var vpc-id=${VPC_ID} \
    --cloud-provider-var route53-private-zone-id=${ROUTE53_PRIVATE_ZONE_ID} \
    --cloud-provider-var subnet-ids=${SUBNET_IDS} \
    --cloud-provider-var master-node-security-group-id=${MASTER_NODE_SECURITY_GROUP_ID} \
    --cloud-provider-var base-node-ami-id=${BASE_NODE_AMI_ID} \
    --cloud-provider-var key-name=${KEY_NAME} \
    --service-mesh envoy \
    --service-mesh-var prepare-image=${CONTROL_PLANE_CONTAINER_CHANNEL}envoy-prepare \
    --service-mesh-var xds-api-image=${CONTROL_PLANE_CONTAINER_CHANNEL}kubernetes-envoy-xds-api-rest-per-node \
    --service-mesh-var redirect-cidr-block=172.16.0.0/16 \
    --networking-provider flannel \
    --networking-provider-var cidr-block=10.200.0.0/16 \
    --terraform-backend S3 \
    --terraform-backend-var bucket=${STATE_S3_BUCKET} \
     && exit 0  # exit on success
  n=$[$n+1]
  sleep 15
done

exit 1
