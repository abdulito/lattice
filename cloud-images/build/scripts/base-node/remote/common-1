#!/usr/bin/env bash
set -e

mkdir -p ~/tmp
cd ~/tmp

echo "Installing kubernetes binaries"
wget https://storage.googleapis.com/kubernetes-release/release/v1.9.0/bin/linux/amd64/kubectl
wget https://storage.googleapis.com/kubernetes-release/release/v1.9.0/bin/linux/amd64/kube-proxy
wget https://storage.googleapis.com/kubernetes-release/release/v1.9.0/bin/linux/amd64/kubelet

chmod +x kubectl kube-proxy kubelet

sudo mkdir -p /opt/kubernetes/bin
sudo mv kubelet kube-proxy kubectl /opt/kubernetes/bin

sudo mkdir -p /opt/bin
sudo ln /opt/kubernetes/bin/kubectl /opt/bin/kubectl

echo "Installing OCI binaries"
sudo mkdir -p /opt/cni/bin
wget https://github.com/containernetworking/plugins/releases/download/v0.6.0/cni-plugins-amd64-v0.6.0.tgz
sudo tar -xvf cni-plugins-amd64-v0.6.0.tgz -C /opt/cni/bin

# Clean up after ourselves
cd ~
rm -rf ~/tmp

echo "Making temporary directory for base-node artifacts"
mkdir -p /tmp/kubernetes/artifacts/base-node

# https://coreos.com/os/docs/latest/update-strategies.html
echo "Disabling CoreOS Container Linux automatic updates"
sudo systemctl stop update-engine
sudo systemctl mask update-engine

sudo systemctl stop locksmithd
sudo systemctl mask locksmithd
