#!/usr/bin/env bash

set -o pipefail
set -e

AVAILABILITY_ZONE=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
REGION=$(echo ${AVAILABILITY_ZONE} | sed 's/.$//')

REPOSITORY=${1}
STATE_S3_BUCKET=$(curl -s http://169.254.169.254/latest/user-data | jq '.lattice.state_s3_bucket' | tr -d '"')

mkdir -p /tmp/terraform-state/ecr-repository/${REPOSITORY}
cp /opt/terraform/modules/ecr-repository/* \
   /tmp/terraform-state/ecr-repository/${REPOSITORY}

cd /tmp/terraform-state/ecr-repository/${REPOSITORY}

/opt/terraform/bin/terraform init -force-copy \
    -backend-config="bucket=${STATE_S3_BUCKET}" \
    -backend-config="key=repositories/${REPOSITORY}/state/terraform.tfstate" \
    -backend-config="region=${REGION}"

/opt/terraform/bin/terraform apply -auto-approve \
    -var "region=${REGION}" \
    -var "repository=${REPOSITORY}"
