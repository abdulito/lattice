#!/usr/bin/env bash

set -o pipefail
set -e

SERVICE_ID=${1}
SERVICE_NODE_INSTANCE_TYPE="t2.small"

/opt/lattice/bin/master-provision-service-node ${SERVICE_ID} ${SERVICE_NODE_INSTANCE_TYPE}

cat <<EOF | /opt/kubernetes/bin/kubectl create -f -
apiVersion: apps/v1beta1
kind: Deployment
metadata:
  name: service-${SERVICE_ID}
spec:
  replicas: 1
  template:
    metadata:
      labels:
        service: ${SERVICE_ID}
    spec:
      dnsPolicy: Default
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: lattice/service
                operator: In
                values:
                  - ${SERVICE_ID}
      tolerations:
      - key: "lattice/service"
        operator: "Equal"
        value: ${SERVICE_ID}
        effect: "NoSchedule"
      - key: "lattice/service"
        operator: "Equal"
        value: ${SERVICE_ID}
        effect: "NoExecute"
      containers:
      - name: service-${SERVICE_ID}
        image: 473720580533.dkr.ecr.us-east-1.amazonaws.com/lattice/kevin-mlab.local/systems/59941a9d1c38584734bd408f/${SERVICE_ID}
        ports:
        - containerPort: 9999
        command:
          - node
          - lib/PrivateHelloService
EOF
