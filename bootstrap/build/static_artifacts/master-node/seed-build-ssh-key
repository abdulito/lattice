#!/usr/bin/env bash

set -o pipefail

echo "Seeding build ssh-key"

/opt/kubernetes/bin/kubectl get secret/build-ssh-key > /dev/null 2>&1
if [[ ${?} -eq 0 ]]; then
    echo "build ssh-key already seeded" && exit
fi

set -e

echo "Generating build ssh-key"
mkdir -p /tmp/seed-build-ssh-key

onexit() {
  rm -rf /tmp/seed-build-ssh-key
}
trap onexit EXIT

ssh-keygen -t rsa -b 4096 -N "" -f /tmp/seed-build-ssh-key/build.key -q

BUILD_PRIVATE_KEY=$(cat /tmp/seed-build-ssh-key/build.key)
BUILD_PUBLIC_KEY=$(cat /tmp/seed-build-ssh-key/build.key.pub)

echo "Adding build ssh-key to kube secrets"
/opt/kubernetes/bin/kubectl create secret generic build-ssh-key --from-literal=private-key="${BUILD_PRIVATE_KEY}" --from-literal=public-key="${BUILD_PUBLIC_KEY}"

printf "\nPlease add the following public key to your github profile:\n${BUILD_PUBLIC_KEY}\n"
